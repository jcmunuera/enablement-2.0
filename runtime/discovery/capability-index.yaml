# ═══════════════════════════════════════════════════════════════════════════════
# CAPABILITY INDEX v2.1
# ═══════════════════════════════════════════════════════════════════════════════
# 
# Single source of truth for capability → feature → implementation → module
# 
# Changes from v2.0:
#   - Skills eliminated (logic moved to features)
#   - Features enriched with config, input_spec, implementations
#   - Stack detection and defaults added
#   - Multi-implementation support per feature
#
# Hierarchy:
#   Capability → Feature → Implementation → Module
#
# ═══════════════════════════════════════════════════════════════════════════════

version: "2.1"
domain: code
last_updated: "2026-01-20"

# ═══════════════════════════════════════════════════════════════════════════════
# ORGANIZATIONAL DEFAULTS
# ═══════════════════════════════════════════════════════════════════════════════

defaults:
  # Default technology stack when not specified or detected
  stack: java-spring
  
  # Default patterns when alternatives exist
  patterns:
    timeout: annotation  # vs client-config

# ═══════════════════════════════════════════════════════════════════════════════
# SUPPORTED STACKS
# ═══════════════════════════════════════════════════════════════════════════════

stacks:
  java-spring:
    description: "Java 17+ with Spring Boot 3.x"
    detection:
      - file: pom.xml
        contains: "spring-boot-starter"
    keywords:
      - java
      - spring
      - spring boot
      - springboot
    
  java-quarkus:
    description: "Java 17+ with Quarkus"
    detection:
      - file: pom.xml
        contains: "quarkus"
    keywords:
      - java
      - quarkus
    
  nodejs:
    description: "Node.js with Express/Fastify"
    detection:
      - file: package.json
    keywords:
      - node
      - nodejs
      - javascript
      - typescript

# ═══════════════════════════════════════════════════════════════════════════════
# CAPABILITIES
# ═══════════════════════════════════════════════════════════════════════════════

capabilities:

  # ─────────────────────────────────────────────────────────────────────────────
  # ARCHITECTURE (structural)
  # ─────────────────────────────────────────────────────────────────────────────
  architecture:
    description: "Foundational architectural patterns that define code structure"
    type: structural
    transformable: false
    documentation: "model/domains/code/capabilities/architecture.md"
    
    features:
      hexagonal-light:
        description: "Hexagonal Light architecture with domain, application, infrastructure layers"
        keywords:
          - hexagonal
          - hexagonal architecture
          - clean architecture
          - ports and adapters
          - DDD
          - domain driven design
          - arquitectura hexagonal
        
        implementations:
          - id: java-spring
            module: mod-code-015-hexagonal-base-java-spring
            stack: java-spring
          # Future:
          # - id: java-quarkus
          #   module: mod-code-015-hexagonal-base-java-quarkus
          #   stack: java-quarkus
          # - id: nodejs
          #   module: mod-code-015-hexagonal-base-nodejs
          #   stack: nodejs
        
        default: java-spring

      # Future feature:
      # hexagonal-full:
      #   description: "Full Hexagonal architecture with additional layers"
      #   implementations:
      #     - id: java-spring
      #       module: mod-code-xxx

  # ─────────────────────────────────────────────────────────────────────────────
  # API-ARCHITECTURE (compositional)
  # Replaces: skill-021 api-rest + api-exposure capability
  # ─────────────────────────────────────────────────────────────────────────────
  api-architecture:
    description: "API types according to Fusion 4-layer model"
    type: compositional
    transformable: true
    documentation: "model/domains/code/capabilities/api_architecture.md"
    keywords:
      - API
      - REST
      - Fusion
      - endpoint
    
    features:
      domain-api:
        description: "Domain API - exposes business capabilities"
        keywords:
          - Domain API
          - API de dominio
          - Fusion Domain
          - business API
          - capacidades de negocio
        
        requires:
          - architecture.hexagonal-light
        
        config:
          hateoas: true
          compensation_available: true
        
        input_spec:
          serviceName:
            type: string
            required: true
            pattern: "^[a-z][a-z0-9-]*$"
            description: "Service name in kebab-case"
            example: "customer-api"
          basePackage:
            type: string
            required: true
            pattern: "^[a-z][a-z0-9]*(\\.[a-z][a-z0-9]*)*$"
            description: "Java base package"
            example: "com.company.customer"
          entities:
            type: array
            required: true
            description: "Domain entities to generate"
            items:
              type: object
              properties:
                name: { type: string }
                fields: { type: array }
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

      system-api:
        description: "System API - wrapper over legacy systems"
        keywords:
          - System API
          - API de sistema
          - wrapper
          - mainframe
          - legacy
          - CICS
        
        requires:
          - architecture.hexagonal-light
        
        config:
          hateoas: false
          compensation_available: false
        
        input_spec:
          serviceName:
            type: string
            required: true
          basePackage:
            type: string
            required: true
          backendSpec:
            type: object
            required: true
            description: "OpenAPI spec of backend system"
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

      experience-api:
        description: "Experience API - BFF for UI channels"
        keywords:
          - Experience API
          - BFF
          - Backend for Frontend
          - mobile
          - web
          - canal
        
        requires:
          - architecture.hexagonal-light
        
        config:
          hateoas: true
          compensation_available: false
        
        input_spec:
          serviceName:
            type: string
            required: true
          basePackage:
            type: string
            required: true
          channel:
            type: string
            enum: [mobile, web, all]
            default: all
          downstreamApis:
            type: array
            description: "Downstream APIs to orchestrate"
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

      composable-api:
        description: "Composable API - multi-domain orchestration"
        keywords:
          - Composable API
          - orchestration
          - orquestación
          - multi-domain
        
        requires:
          - architecture.hexagonal-light
        
        config:
          hateoas: false
          compensation_available: false
        
        input_spec:
          serviceName:
            type: string
            required: true
          basePackage:
            type: string
            required: true
          orchestration:
            type: object
            description: "Orchestration definition"
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

  # ─────────────────────────────────────────────────────────────────────────────
  # INTEGRATION (compositional)
  # Normalized from KB: integration capability with sub-features
  # ─────────────────────────────────────────────────────────────────────────────
  integration:
    description: "Patterns for integrating with external systems"
    type: compositional
    transformable: true
    documentation: "model/domains/code/capabilities/integration.md"
    keywords:
      - integration
      - integración
      - external API
      - API externa
    
    features:
      api-rest:
        description: "Synchronous REST integration with RestClient"
        keywords:
          - REST client
          - HTTP client
          - RestClient
          - integración REST
          - API client
          - consumir API
        
        implementations:
          - id: java-spring-restclient
            module: mod-code-018-api-integration-rest-java-spring
            stack: java-spring
            description: "Spring RestClient (synchronous)"
          # Future:
          # - id: java-spring-webclient
          #   module: mod-code-018b-api-integration-webclient-java-spring
          #   stack: java-spring
          #   description: "Spring WebClient (reactive)"
        
        default: java-spring-restclient

      # Future features:
      # api-grpc:
      #   description: "gRPC integration"
      #   keywords: [gRPC, protobuf, RPC]
      #   implementations:
      #     - id: java-spring
      #       module: mod-code-xxx
      #
      # event-kafka:
      #   description: "Kafka event integration"
      #   keywords: [Kafka, events, event-driven]
      #   implementations:
      #     - id: java-spring
      #       module: mod-code-xxx

  # ─────────────────────────────────────────────────────────────────────────────
  # PERSISTENCE (compositional)
  # ─────────────────────────────────────────────────────────────────────────────
  persistence:
    description: "Data persistence strategies"
    type: compositional
    transformable: true
    documentation: "model/domains/code/capabilities/persistence.md"
    keywords:
      - persistence
      - persistencia
      - data
      - datos
      - storage
      - database
      - base de datos
    
    features:
      jpa:
        description: "JPA/Hibernate persistence with relational database"
        keywords:
          - JPA
          - Hibernate
          - database
          - SQL
          - relational
          - ORM
          - entity
          - repository
        
        incompatible_with:
          - persistence.systemapi
        
        implementations:
          - id: java-spring
            module: mod-code-016-persistence-jpa-spring
            stack: java-spring
        
        default: java-spring

      systemapi:
        description: "Persistence delegated to System API (legacy backend)"
        keywords:
          - System API
          - backend
          - legacy
          - mainframe
          - CICS
          - host
        
        requires:
          - integration.api-rest
        
        incompatible_with:
          - persistence.jpa
        
        implementations:
          - id: java-spring
            module: mod-code-017-persistence-systemapi
            stack: java-spring
        
        default: java-spring

  # ─────────────────────────────────────────────────────────────────────────────
  # RESILIENCE (compositional)
  # ─────────────────────────────────────────────────────────────────────────────
  resilience:
    description: "Fault tolerance and resilience patterns"
    type: compositional
    transformable: true
    documentation: "model/domains/code/capabilities/resilience.md"
    keywords:
      - resilience
      - resiliencia
      - fault tolerance
      - tolerancia a fallos
      - stability patterns
      - patrones de estabilidad
    
    features:
      circuit-breaker:
        description: "Circuit Breaker to prevent cascade failures"
        keywords:
          - circuit breaker
          - cortocircuito
          - breaker
          - fail fast
        
        implementations:
          - id: java-spring-resilience4j
            module: mod-code-001-circuit-breaker-java-resilience4j
            stack: java-spring
            pattern: annotation
        
        default: java-spring-resilience4j

      retry:
        description: "Retry with exponential backoff"
        keywords:
          - retry
          - reintento
          - backoff
          - exponential backoff
        
        implementations:
          - id: java-spring-resilience4j
            module: mod-code-002-retry-java-resilience4j
            stack: java-spring
            pattern: annotation
        
        default: java-spring-resilience4j

      timeout:
        description: "Timeout to limit wait times"
        keywords:
          - timeout
          - tiempo límite
          - time limit
          - deadline
        
        implementations:
          - id: java-spring-annotation
            module: mod-code-003-timeout-java-resilience4j
            stack: java-spring
            pattern: annotation
            description: "@TimeLimiter from Resilience4j"
          # Future alternative:
          # - id: java-spring-client-config
          #   module: mod-code-003b-timeout-restclient
          #   stack: java-spring
          #   pattern: client-config
          #   description: "Timeout configured in RestClient"
        
        default: java-spring-annotation

      rate-limiter:
        description: "Rate Limiter to control request throughput"
        keywords:
          - rate limit
          - rate limiter
          - throttling
          - límite de tasa
          - control de tráfico
        
        implementations:
          - id: java-spring-resilience4j
            module: mod-code-004-rate-limiter-java-resilience4j
            stack: java-spring
            pattern: annotation
        
        default: java-spring-resilience4j

  # ─────────────────────────────────────────────────────────────────────────────
  # DISTRIBUTED-TRANSACTIONS (compositional)
  # ─────────────────────────────────────────────────────────────────────────────
  distributed-transactions:
    description: "Patterns for handling distributed transactions"
    type: compositional
    transformable: true
    documentation: "model/domains/code/capabilities/distributed_transactions.md"
    keywords:
      - saga
      - distributed transaction
      - transacción distribuida
      - eventual consistency
      - consistencia eventual
    
    features:
      saga-compensation:
        description: "SAGA pattern with compensation for rollback"
        keywords:
          - compensation
          - compensación
          - saga
          - rollback
          - undo
        
        implementations:
          - id: java-spring
            module: mod-code-020-compensation-java-spring
            stack: java-spring
        
        default: java-spring

# ═══════════════════════════════════════════════════════════════════════════════
# FUTURE CAPABILITIES (Placeholders)
# ═══════════════════════════════════════════════════════════════════════════════

  # caching:
  #   description: "Caching strategies"
  #   type: compositional
  #   features:
  #     redis:
  #       keywords: [Redis, distributed cache]
  #     local:
  #       keywords: [local cache, Caffeine, in-memory]

  # security:
  #   description: "Security patterns"
  #   type: compositional
  #   features:
  #     oauth2:
  #       keywords: [OAuth2, JWT, authentication]
  #     api-key:
  #       keywords: [API key, authentication]

  # observability:
  #   description: "Observability and monitoring"
  #   type: compositional
  #   features:
  #     metrics:
  #       keywords: [metrics, Prometheus, Micrometer]
  #     tracing:
  #       keywords: [tracing, OpenTelemetry, Jaeger]

# ═══════════════════════════════════════════════════════════════════════════════
# MODULE SUMMARY
# ═══════════════════════════════════════════════════════════════════════════════
#
# Current modules (java-spring):
#   mod-code-001-circuit-breaker-java-resilience4j
#   mod-code-002-retry-java-resilience4j
#   mod-code-003-timeout-java-resilience4j
#   mod-code-004-rate-limiter-java-resilience4j
#   mod-code-015-hexagonal-base-java-spring
#   mod-code-016-persistence-jpa-spring
#   mod-code-017-persistence-systemapi
#   mod-code-018-api-integration-rest-java-spring
#   mod-code-019-api-public-exposure-java-spring
#   mod-code-020-compensation-java-spring
#
# ═══════════════════════════════════════════════════════════════════════════════
